<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Code Ingest</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <!-- 
      Comprehensive UI Overhaul 3.0:
    - Renamed to "Code Ingest" and added the extension icon.
      - Implemented a beautiful, structured dark-themed view.
      - Organized all controls into beginner-friendly collapsible sections.
      - Ensured all functionalities from main.js are present and correctly wired.
      - Created a fixed-height, scrollable container for the file tree.
    -->

    <!-- Inline SVG sprite for icons -->
    <svg aria-hidden="true" data-sprite>
        <!-- Symbol definitions only. Keep titles/headings out of the sprite. -->
        <symbol id="icon-refresh" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1l-4 4 4 4V5c2.76 0 5.26 1.12 7.07 2.93L20 11h3V8l-5.35-1.65zM6.35 17.65A7.95 7.95 0 0 0 12 20v3l4-4-4-4v3c-2.76 0-5.26-1.12-7.07-2.93L4 13H1v3l5.35 1.65z"/></symbol>
        <symbol id="icon-close" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.41 4.29 19.71 2.88 18.3 9.18 12 2.88 5.71 4.29 4.29 10.59 10.59 16.88 4.29z"/></symbol>
        <symbol id="icon-chevron-up" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></symbol>
    <!-- additional symbols can be defined below -->
        <symbol id="icon-settings" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.62l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.027 7.027 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.75 2h-3.5a.5.5 0 0 0-.5.43l-.36 2.54c-.57.22-1.1.52-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7 8.88a.5.5 0 0 0 .12.62l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L2.82 15.9a.5.5 0 0 0-.12.62l1.92 3.32c.14.24.44.34.7.22l2.39-.96c.5.42 1.06.76 1.63.94l.36 2.54c.05.27.28.46.55.46h3.5c.27 0 .5-.19.55-.46l.36-2.54c.57-.18 1.13-.52 1.63-.94l2.39.96c.26.11.56.02.7-.22l1.92-3.32a.5.5 0 0 0-.12-.62l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z"/>
        </symbol>
        <!-- Alias for other icon sets that reference a different id (ensures header uses an available id) -->
        <symbol id="icon-settings-gear" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14 12.94c.04-.31.06-.63.06-.94s-.02-.63-.06-.94l2.03-1.58a.5.5 0 0 0 .12-.62l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.027 7.027 0 0 0-1.63-.94l-.36-2.54A.5.5 0 0 0 13.75 2h-3.5a.5.5 0 0 0-.5.43l-.36 2.54c-.57.22-1.1.52-1.63.94l-2.39-.96a.5.5 0 0 0-.6.22L2.7 8.88a.5.5 0 0 0 .12.62l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94L2.82 15.9a.5.5 0 0 0-.12.62l1.92 3.32c.14.24.44.34.7.22l2.39-.96c.5.42 1.06.76 1.63.94l.36 2.54c.05.27.28.46.55.46h3.5c.27 0 .5-.19.55-.46l.36-2.54c.57-.18 1.13-.52 1.63-.94l2.39.96c.26.11.56.02.7-.22l1.92-3.32a.5.5 0 0 0-.12-.62l-2.03-1.58zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z"/>
        </symbol>
    <symbol id="icon-check" viewBox="0 0 16 16" fill="currentColor"><path d="M13.485 1.929a1 1 0 0 1 1.415 1.414l-8.25 8.25a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 1.414-1.414L6 9.586l7.485-7.657z"/></symbol>
        <symbol id="icon-cloud-download" viewBox="0 0 24 24" fill="currentColor"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></symbol>
                <symbol id="icon-generate" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7v6c0 5 4 9 10 9s10-4 10-9V7l-10-5zm0 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></symbol>
                <!-- compact inline logo symbol for header (scales with currentColor) -->
                <symbol id="icon-logo" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="2" y="2" width="20" height="20" rx="4" ry="4"></rect>
                    <path d="M9 8h1v8H9zM14 8h1v8h-1z" fill="#fff" opacity="0.9"></path>
                </symbol>
    </svg>

    <div class="container" id="dashboard">
        <header class="main-header">
            <!-- logo src is rewritten by the extension host (setWebviewHtml) to a webview URI; keep ../icons/... so the helper can resolve it -->
            <img class="logo" src="../icons/icon.png" data-webview-src="../icons/icon.png" alt="Code Ingest" />
            <div id="workspace-info">
                    <h1>Code Ingest</h1>
                <div id="workspace-slug" aria-live="polite">&nbsp;</div>
            </div>
             <div class="header-actions">
                <button id="btn-ingest-remote" type="button" data-action="ingestRemote" title="Ingest Remote Repository">
                    <svg class="icon"><use href="#icon-cloud-download"></use></svg>
                </button>
                <button id="openSettings" type="button" data-action="openSettings" title="Open Settings">
                    <svg class="icon"><use href="#icon-settings"></use></svg>
                </button>
                <button id="btn-pause-resume" type="button" data-action="togglePause" aria-pressed="false" title="Pause/Resume">
                    <svg class="icon"><use href="#icon-refresh"></use></svg>
                    <span class="sr-only">Pause</span>
                </button>
                <button id="preset-btn" type="button" aria-haspopup="true" aria-expanded="false" title="Presets">
                    <svg class="icon"><use href="#icon-check"></use></svg>
                    <span>Presets</span>
                </button>
                <button id="btn-disable-redaction" type="button" aria-pressed="false" title="Toggle redaction (show/hide redacted content)">
                    <svg class="icon"><use href="#icon-close"></use></svg>
                    <span class="sr-only">Toggle redaction</span>
                </button>
            </div>
        </header>

        <!-- Visible preset menu (previously hidden) - kept adjacent to header for positioning -->
        <div id="preset-menu" role="listbox" aria-label="Presets" aria-hidden="true" hidden aria-multiselectable="false">
            <button role="option" data-preset="codeOnly" tabindex="-1">Code Only</button>
            <button role="option" data-preset="docsOnly" tabindex="-1">Docs Only</button>
            <button role="option" data-preset="testsOnly" tabindex="-1">Tests Only</button>
        </div>
        </div>

        <script>
            // Keep preset menu `hidden` and `aria-hidden` attributes consistent.
            // Some existing handlers toggle only `hidden` — observe and normalize.
            (function() {
                const btn = document.getElementById('preset-btn');
                const menu = document.getElementById('preset-menu');
                if (!menu) return;

                // Normalize initial state
                if (menu.hasAttribute('hidden')) {
                    menu.setAttribute('aria-hidden', 'true');
                } else {
                    menu.setAttribute('aria-hidden', 'false');
                }

                // Toggle function used by this file to open/close the menu.
                function togglePresetMenu() {
                    if (menu.hasAttribute('hidden')) {
                        menu.removeAttribute('hidden');
                        menu.setAttribute('aria-hidden', 'false');
                        btn && btn.setAttribute('aria-expanded', 'true');
                    } else {
                        menu.setAttribute('hidden', '');
                        menu.setAttribute('aria-hidden', 'true');
                        btn && btn.setAttribute('aria-expanded', 'false');
                    }
                }

                // Click handler for the preset button — prefer this toggle to ensure consistency
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        togglePresetMenu();
                    });
                }

                // If other code mutates `hidden` directly, keep aria-hidden in sync.
                const obs = new MutationObserver(mutations => {
                    for (const m of mutations) {
                        if (m.attributeName === 'hidden') {
                            if (menu.hasAttribute('hidden')) {
                                if (menu.getAttribute('aria-hidden') !== 'true') {
                                    menu.setAttribute('aria-hidden', 'true');
                                }
                                btn && btn.setAttribute('aria-expanded', 'false');
                            } else {
                                if (menu.getAttribute('aria-hidden') !== 'false') {
                                    menu.setAttribute('aria-hidden', 'false');
                                }
                                btn && btn.setAttribute('aria-expanded', 'true');
                            }
                        }
                    }
                });

                obs.observe(menu, { attributes: true, attributeFilter: ['hidden'] });

                // Close menu on escape or click outside for accessibility
                document.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Escape' && !menu.hasAttribute('hidden')) {
                        menu.setAttribute('hidden', '');
                        menu.setAttribute('aria-hidden', 'true');
                        btn && btn.setAttribute('aria-expanded', 'false');
                    }
                });

                document.addEventListener('click', (ev) => {
                    if (!menu.contains(ev.target) && ev.target !== btn && !menu.hasAttribute('hidden')) {
                        menu.setAttribute('hidden', '');
                        menu.setAttribute('aria-hidden', 'true');
                        btn && btn.setAttribute('aria-expanded', 'false');
                    }
                });
            })();
        </script>
        <div class="action-bar">
             <button id="btn-refresh" class="secondary" type="button" data-action="refresh" title="Refresh File List">
                <svg class="icon"><use href="#icon-refresh"></use></svg>
                <span>Refresh</span>
            </button>
            <button class="primary" type="button" data-action="generateDigest" title="Generate Digest from Selected Files">
                 <svg class="icon"><use href="#icon-generate"></use></svg>
                Generate Digest
            </button>
        </div>
        
        <details class="collapsible-section" open>
            <summary class="section-header">
                <h3>Details & Status</h3>
                <svg class="icon chevron"><use href="#icon-chevron-down"></use></svg>
            </summary>
            <div class="section-body">
                <div id="status-chips" class="chip-row" aria-live="polite" aria-atomic="true"></div>
                <div class="progress-wrapper">
                    <div id="progress-container" aria-busy="false">
                        <div id="progress-bar" role="progressbar" aria-label="Scan progress" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="progress-stats" aria-live="polite" aria-atomic="true"></div>
                    <!-- Visually-hidden live status for screen readers (updated by script) -->
                    <span id="progress-status" class="sr-only" aria-live="polite" aria-atomic="true"></span>
                </div>
                 <div id="stats"></div>
            </div>
        </details>

        <details class="collapsible-section file-section" open>
             <summary class="section-header">
                <h3>File Selection</h3>
                <svg class="icon chevron"><use href="#icon-chevron-down"></use></svg>
            </summary>
            <div class="section-body" id="toolbar">
                <div class="segmented" role="toolbar" aria-label="File selection controls">
                    <button type="button" data-action="selectAll" title="Select All"><svg class="icon"><use href="#icon-check"></use></svg> All</button>
                    <button type="button" data-action="clearSelection" title="Clear Selection"><svg class="icon"><use href="#icon-close"></use></svg> None</button>
                    <button type="button" data-action="expandAll" title="Expand All Folders"><svg class="icon"><use href="#icon-chevron-down"></use></svg> Expand</button>
                    <button type="button" data-action="collapseAll" title="Collapse All Folders"><svg class="icon"><use href="#icon-chevron-up"></use></svg> Collapse</button>
                </div>
                <div id="file-list-container">
                    <div id="file-list">
                         <div class="file-row-message">Scanning workspace...</div>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- Hidden Elements -->
    <div id="toast-root" aria-live="polite" aria-atomic="true"></div>

    <div id="ingestModal" class="modal-wrapper" hidden>
        <div class="modal-overlay" id="ingest-cancel-overlay"></div>
        <div class="modal-content">
            <h3>Ingest Remote Repository</h3>
            <button class="modal-close" id="ingest-close" aria-label="Close">
                <svg class="icon"><use href="#icon-close"></use></svg>
            </button>
            <label>Repo URL or slug: <input id="ingest-repo" type="text" placeholder="owner/repo or https://github.com/owner/repo" /></label>
            <label>Ref (branch/tag/commit): <input id="ingest-ref" type="text" placeholder="branch or tag or commit (optional)" /></label>
            <label>Subpath (optional): <input id="ingest-subpath" type="text" placeholder="src/app/" /></label>
            <label class="checkbox-label"><input id="ingest-submodules" type="checkbox" /> Include submodules</label>
            <div id="ingest-preview">
                <div class="spinner" id="ingest-spinner" aria-hidden="true" hidden></div>
                <pre class="ingest-text" id="ingest-preview-text" aria-live="polite"></pre>
            </div>
            <div class="modal-actions">
                <button id="ingest-cancel" class="secondary">Cancel</button>
                <button id="ingest-load-repo" class="primary">Load Repo</button>
                <button id="ingest-submit" class="primary" hidden>Start Ingest</button>
            </div>
        </div>
    </div>

    <div id="settings" class="modal-wrapper" hidden>
        <div class="modal-overlay" id="settings-cancel-overlay"></div>
        <div class="modal-content">
            <h3>Settings</h3>
            <button class="modal-close" id="settings-close" aria-label="Close">
                <svg class="icon"><use href="#icon-close"></use></svg>
            </button>
            <form id="settingsForm">
                 <label class="checkbox-label"><input type="checkbox" name="gitignore" /> Respect .gitignore</label>
                    
                <div class="form-group">
                    <label>Output format</label>
                    <select name="outputFormat">
                        <option value="text">Text</option>
                        <option value="json">JSON</option>
                        <option value="markdown">Markdown</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Token model</label>
                    <select name="tokenModel">
                        <option value="chars-approx">Structure 0:chars-approx</option>
                        <option value="gpt-4o">Structure 0:gpt-4o</option>
                        <option value="gpt-3.5">Structure 0:gpt-3.5</option>
                        <option value="gpt-4o-mini">Structure 0:gpt-4o-mini</option>
                        <option value="gpt-4o-mini-8k">Structure 8000:gpt-4o-mini-8k</option>
                        <option value="gpt-4o-mini-16k">Structure 16000:gpt-4o-mini-16k</option>
                        <option value="claude-3.5">Structure 0:claude-3.5</option>
                        <option value="claude-2.1">Structure 0:claude-2.1</option>
                        <option value="claude-2">Structure 0:claude-2</option>
                        <option value="o200k">Structure 200000:o200k</option>
                        <option value="o1">Structure 0:o1</option>
                        <option value="o2">Structure 0:o2</option>
                        <option value="tiktoken">Structure 0:tiktoken</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Binary policy</label>
                    <select name="binaryPolicy">
                        <option value="skip">Skip</option>
                        <option value="include">Include Placeholder</option>
                    </select>
                </div>
                
                <fieldset class="limit-group">
                    <legend>Limits</legend>
                    <div class="limit-row">
                        <label for="maxFilesNumber">Max files</label>
                        <input id="maxFilesNumber" type="number" name="thresholds.maxFiles" aria-label="Max files" />
                        <input id="maxFilesRange" type="range" min="100" max="50000" step="100" />
                    </div>
                    <div class="limit-row">
                        <label for="maxTotalSizeNumber">Max total size (MB)</label>
                            <input id="maxTotalSizeNumber" type="number" name="thresholds.maxTotalSizeBytes" aria-label="Max total size (MB)" />
                        <input id="maxTotalSizeRange" type="range" min="1" max="4096" step="1" />
                    </div>
                    <div class="limit-row">
                        <label for="tokenLimitNumber">Token limit</label>
                        <input id="tokenLimitNumber" type="number" name="thresholds.tokenLimit" aria-label="Token limit" />
                        <input id="tokenLimitRange" type="range" min="256" max="200000" step="256" />
                    </div>
                </fieldset>
                
                <fieldset class="safety-group">
                    <legend>Safety / Redaction</legend>
                    <label class="checkbox-label"><input type="checkbox" name="showRedacted" /> Show redacted (disable masking)</label>
                    <div class="form-group">
                        <label>Redaction patterns (one per line or comma-separated)</label>
                        <textarea name="redactionPatterns" rows="3" placeholder="e.g. /SECRET_[A-Z]+/g, PASSWORD=\\S+"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Redaction placeholder</label>
                        <input type="text" name="redactionPlaceholder" />
                    </div>
                </fieldset>

                <div class="form-group">
                    <label>Presets (comma-separated)</label>
                    <input type="text" name="presets" />
                </div>
                <div class="modal-actions">
                    <button id="cancelSettings" type="button" class="secondary">Cancel</button>
                    <button id="saveSettings" type="button" class="primary">Save Settings</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Hidden toolbar for JS functionality that doesn't need a visible button in the new UI -->
    <div hidden id="hidden-toolbar">
        <button id="btn-cancel-write" type="button" data-action="cancelWrite"></button>
        <button id="btn-token-count" type="button" data-action="tokenCount"></button>
    <!-- redaction toggle moved to visible header for discoverability -->
    </div>

    <script src="./main.js"></script>
</body>
</html>
